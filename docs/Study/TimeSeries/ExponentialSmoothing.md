# 指数平滑法

## 简单指数平滑法 

在移动平均法中，我们规定了一个固定长度的滑动窗口，将这个窗口内的需求均值（或者加权均值）作为下一个时刻的预测值。这种方法在应用时可能缺乏灵活度、无法利用移动平均窗口外的需求数据，同时，预测过程除了实际值外，还伴随有历史数据的预测误差。我们同样希望借助过去“真实值与预测值的误差”，给新的时刻的需求预测提供一些启发。
- 我们用 $y_t$ 表示 $t$ 时刻的实际需求数据。用 $\hat{y}_{t+1|t}$ 表示 $t$ 时刻对 $t+1$ 时刻需求的预测值。我们事先给定权重 $\alpha \in [0,1]$。
- 我们用$\hat{y}_{t+1|t}$表示在$t$时刻对$t+1$时刻的需求预测值。可以把指数平滑的公式写成：
$\hat{y}_{t+1|t} = \alpha y_t + (1-\alpha) \hat{y}_{t|t-1}$
由该公式可知，下一个时刻需求的预测值，等于该时刻的实际需求，与前一时刻对当前时刻的指数平滑预测值的加权和。
正因为预测值也包括了前一时刻的预测值，所以指数平滑实际上利用了所有的历史数据，只不过先前历史数据的权重会随着时间推移，指数下降，变得越来越不重要，而靠近现在的数据会占有更高的权重。
比如，对于时间序列：[10, 20, 40, 20, 30, 30]，借助简单指数平滑进行预测。将最后一个时刻的数据作为测试集，假定$\alpha = 0.5$：
- 在1时刻，知道了当前需求10，由于没有上期的预测值，所以对下一时期的预测值为：$0.5 \times 10 + 0 = 5$；
- 在2时刻，知道了当前需求20，上期预测5，所以对下一时刻的预测值为: $0.5 \times 20 + 0.5 \times 5 = 12.5$
- 在3时刻，知道了当前需求40，上期预测12.5，所以对下一时刻的预测值为: $0.5 \times 40 + 12.5 \times 0.5 = 26.25$
- 在4时刻，知道了当前需求20，上期预测26.25，所以对下一时刻预测值为 $0.5 \times 20 + 26.25 \times 0.5 = 23.125$
- 在5时刻，知道了当前需求30，上期预测23.125，所以对下一时刻的预测值为：$0.5 \times 30 + 23.125 \times 0.5 = 26.5625$
这个值与真实值（30）的相关评价函数均可对应计算出来。

---
调参

可见，在不考虑多余因素的情况下，指数平滑的计算结果仅和$\alpha$有关，所以通过取不同$\alpha$，评估预测结果，就可以选出最优权重。

考虑趋势项(Holt Model)

简单指数平滑方法默认不考虑趋势项和季节项，一般而言称为“水平项”预测。如果考虑趋势项，指数平滑的迭代公式会有所不同。这种模型也被称为Holt模型。（Holt's Linear trend method)
下一个时刻的需求，是由水平项$l_t$和趋势项$b_t$共同决定。也就是：
$\hat{y}_{t+1|t} = l_t +  b_t $
其中水平项$l_t = \alpha y_t + (1 - \alpha) (l_{t-1} + b_{t-1})$。
可以看到，相比于简单的指数平滑，水平项不只是由实际需求与前一个时期的预测值来决定，而是同时考虑实际需求、前一个时期的预测值、趋势项。
这里的趋势项，本身也是利用简单指数平滑推导而来的：
$b_t = \beta (l_t - l_{t-1}) + (1 - \beta) b_{t-1}$
可以将这里的$b_t$理解为水平项在$t$时刻的“斜率”。
我们把水平项的参数$\alpha$称为水平项平滑参数，$\beta$称为趋势项平滑参数。与简单指数平滑不同，我们对于趋势项指数平滑需要求出2个不同的参数。
如果借助趋势项做$h$步前向预测，那么公式变为：
$\hat{y}_{t+h|t} = l_t + h b_t $
也就是说对未来进行多步预测， 结果实际上是当前预测的下一时刻的水平项 + 趋势项与步数的乘积。也就是说，是一个与$h$有关的线性函数。
针对趋势项的Damp方法
上述处理趋势的手段，如果进行多步预测，则$b_t$都是相同的。实证数据发现，如果预测步长较长，这种方式会高估实际需求。
为了增强预测的稳定性， Gardner & McKenzie (1985) 指出可以通过在趋势项上增加额外系数$\phi$，让趋势项在一定步长后近似被拉平（Flat），一些实际数据中能获得较好的效果。
[Image]

 Gardner & McKenzie (1985) introduced a parameter that “dampens” the trend to a flat line some time in the future. Methods that include a damped trend have proven to be very successful, and are arguably the most popular individual methods when forecasts are required automatically for many series. （来源：source)
这个公式有一个理解角度：
- 在没有引入$\phi$之前，对$h$步未来预测，$b_t$前的系数应该是正整数$h$，
- 现在变成了一个长度为$h$，首项为$\phi$，公比为$\phi<1$的等比数列的和，随着$\phi$的增加，数列和的增加速度会迅速下降，近似于拉平了趋势项。
实际上，$\phi$取值对于较短的多步预测是很敏感的，取得太小，第一个预测值的趋势项的重要性会被低估；如果去的太大，也就失去了Flatten的效果。根据Reference Book的经验，应该取值在 [0.8, 0.98]之间。
同时考虑趋势项和季节项(Holt-Winter)

又被称为Holt-Winters模型，它将下一个时刻的需求视为如下三个部分的和：
1. 当前时刻的实际需求$l_t$；
2. 趋势项$b_t$；
3. 要预测的时刻的季节项$s_{t+h-m(k+1)}$；
理解一下这里的$k,m$，$m$是季节长度，比如季度数据，那么$m = 4$，如果是月度数据，$m = 12$,以此类推。
这里的$k$是$\dfrac{h-1}{m}$的整数部分。${t+h-m(k+1)}$的作用就是限制了要预测时刻的季节项等于上一个已知对应季节项。
> e.g. t = 100, h = 22, m = 5。我们要预测第122时刻。此时该时刻对应的季节 = 122 - 5 * (4 + 1) = 97，正好就是已知时刻里，最近的对应的季节项。
> 
> 整个公式写成：
> 
> $\hat{y}_{t+1|t} = l_t + b_t + s_{t + 1 - m(k+1)}$
> 
> 公式中，$l_t = \alpha (y_t - s_{t - m})+ (1 - \alpha) (l_{t-1} + b_{t-1}) $,称为水平项。可以视为：当前时刻减去季节项后的真实需求，与前一个时刻，水平项值与趋势项之和的指数平滑。
> 
> 公式中，$b_t = \beta (l_t - l_{t-1}) + (1-\beta)b_{t-1}$，称为趋势项，可以视为当前时刻水平项的变化值与前一个时刻趋势项的指数平滑。
> 
> 公式中，$s_t = \gamma (y_t - l_{t-1} - b_{t-1}) + (1 - \gamma) s_{t - m}$，是季节项。可以视为：当前时刻减去趋势项和水平项后，由季节项决定的那部分需求，与上一个周期对应季节项的指数平滑。
[Image]


针对季节项的加法模型和乘法模型
同时考虑趋势项和季节项目的模型中，各个组成部分通过加法组合，形成对下一个时刻的预测：
$\hat{y}_{t+1|t} = l_t + b_t + s_{t + 1 - m(k+1)}$
如果将季节项作为一个乘数，乘到水平项+ 趋势项上，形成的Holt-Winter模型就是乘法模型：
$\hat{y}_{t+1|t} = (l_t + b_t )s_{t+h-m(k+1)}$
 两种模型都是刻画趋势项和季节项的方法。但是需要注意，加法模型和乘法模型，改变/操作的对象，都是季节项，与趋势项是无关的。
[Image]
[Image]

[Image]

Damp 方法

与前面提到的方法一样。是应对线性趋势项在长步长预测中，后期会夸大趋势项水平的情况提出的解决方案。解决方法依然是添加一个指数项，对步长较长的部分进行修正。不赘述。
[Image]

---

关于指数平滑进一步的划分与讨论
到目前为止，上面的内容已经讨论了几个因素，可以罗列：
1. 简单指数平滑
2. 考虑季节项的ES
3. 考虑趋势项的ES
4. 趋势项是否考虑Damped修正
5. 季节项采取加法or乘法模型
有没有一种办法，可以灵活地选取某个最好的指数平滑的组合，对未来进行预测呢？
给出如下的标记方法：
[Image]
对趋势项，可以用$N,A,A_d$分别区分 不考虑趋势、考虑趋势、考虑damped的趋势 三种情况。
对季节项，可以用$N, A, M$分别区分 不考虑季节、考虑加法季节项、考虑乘法季节项 三种情况。
相互组成笛卡尔积，一个二元组，一共有9个不同的模型。
他们的总结可以写成如下的形式：
[Image]
上面的所有模型均基于点预测的（Point Forecast），没有办法进行区间预测。
如何基于历史数据进行区间预测？给出需求可能的概率分布情况？

---

State Space Models (状态空间模型)
在前面所有的模型中，误差都是通过加减法计算得来的，也就是$e_t = y_t - \hat{y}_{t|t-1}$，而实际上，误差也可以通过乘法法则计算。为了和季节项中的乘法和加法模型进行区分，需要引入一个新的指标，加上前一节提出的对趋势项、季节项的指标，可以组成一个三元组，对模型进行划分。(Error, Trend, Seasonal)，用 E, T, S 进行表示。 （E, T, S)
ETS(A,N,N): 考虑加法误差的简单指数平滑
用简单的指数平滑做示例。
[Image]
该时刻的水平项 = 上一时刻的水平项 + $\alpha e_t$.
如何对残差进行分析？
此时我们假定误差$e_t $，服从$N(0, \sigma^2)$的正态分布$\varepsilon_t$，是一个白噪声。
所以有:
$y_t = l_{t-1} + \varepsilon_t, \tag{1.1}$
$l_t = l_{t-1} + \alpha \varepsilon_t \tag{1.2}$
- 1.1 称为 Measurement Equation，将真实值表示为预测值$l_{t-1}$（对应于真实需求中可以被预测的那部分）与误差$\varepsilon_t$（对应真实需求中没有被预测的部分）的线性函数。
- 1.2 称为 State Equation. 表示预测过程中状态的转换。$\alpha$可以理解为前后两个需求水平变化的幅度。
此时可以引出状态空间模型的概念:
Each model consists of a measurement equation that describes the observed data, and some state equations that describe how the unobserved components or states (level, trend, seasonal) change over time. Hence, these are referred to as state space models.


ETS(M, N, N) 考虑乘法误差的简单指数平滑
乘法误差是如何刻画的？
[Image]
也就是用 （真实值 - 预测值）/ 预测值 来反映误差的情况。此时假定$\varepsilon_t$ 依然是均值为0 的正态分布。
对应的，我们有
 $y_t = l_{t-1} + l_{t-1} \varepsilon_t \tag{1.3}$可以看到真实值是通过，预测值与预测值和误差的乘积，两个数之和计算出来的。
所以可以写出如下的Measurement Equation 和State Equation:
$y_t  = l_{t-1} (1 + \varepsilon_t) \tag{1.4}$
$l_t = l_{t-1} (1 + \alpha \varepsilon_t) \tag{1.5}$
上述的重点在于，将概率分布的概念（而不只是误差）融入到了时间序列的计算中。
同样地，我们通过3个参数，(A, M) , (N, A, A_d), (N, A, M), 利用笛卡尔积，可以区分出18个不同的模型：

[Image]
值得注意的是，在一些模型中，尤其是季节因素考虑乘法模型时，模型参数的取值范围有限制，比如 $0 < \beta < \alpha$等。
ETS 模型的参数估计
对于误差为加法模型，最大化概率与最小均方误差的结果是一样的，但是对于误差乘法的模型，结果会不同。
简而言之，就是对$\alpha, \beta, \gamma, \phi$（平滑参数）以及初始状态 $l_0, b_0, s_0, s_{-1} $等进行估计。
在点估计模型中，我们调参的手段，是通过不同的参数组合，求出使得样本内测试集上MSE最小的那个，当作最优参数。
但是当误差变成正态分布之后，无法利用之前相同的方法进行估计了。我们转而使用极大似然估计法：
找到具有某个误差概率分布的模型，使得真实的需求值产生自该模型的概率最大。
书中并没有对调参的过程给出足够详细的解释。但是指出了针对3个模型， ETS(A, N, M), ETS(A, A, M)， ETS(A, A_d, M)，他们在状态方程上可能出现分母过小接近0的状态，在选择模型的时候一般不予考虑。

Models with multiplicative errors are useful when the data are strictly positive, but are not numerically stable when the data contain zeros or negative values. Therefore, multiplicative error models will not be considered if the time series is not strictly positive. In that case, only the six fully additive models will be applied.
进行模型选择
对于多个ETS模型，基于给定的时间序列，借助AIC / BIC 准则选择最适合的模型组合 E, T, S。这一部分讲得不是很理解。
- AIC准则：（Akaike's Information Criterion)
  - $AIC = - 2 \log(L) + 2 k$，其中$L$是，历史数据来自于给定的某个模型对应的参数组合的概率，一般通过极大似然估计给出。$k$是已经估计的所有参数和初始状态参数的数量 （对应统计学中的independent variables)。
- BIC 准则：（Bayesian Information Criterion)
  - $BIC = AIC + k [ \log(T) - 2 ]$


基于ETS进行区间预测

对于大部分ETS模型，可以把预测区间写作如下格式：
$\hat{y}_{T + h | T} \pm c \sigma_h$
这里的$c$依赖于指定的Coverage Possibility给出的乘数，也就是为了满足置信水平，在标准正态分布下，自变量对应的取值的上下界。也就是这张表：
[Image]
[Image]
公式里的$\sigma_h$指的是预测的标准差（Forecast variance）。这个值的推导的过程非常复杂，加法部分的推导可以参考：
[Image]
可以理解为，对未来多个时间的预测的方差，等于最优模型相关参数与残差的标准差之间的一个解析式。

一个演示demo如下：
[Image]
ETS和指数平滑的区别与共性

我的理解：
区别：
1. 对残差（residuals）的处理不同：同时考虑加法和乘法模式；
2. 将残差与概率分布结合起来，使得能够给出一个区间预测；
3. 在比较不同模型的时候使用AIC/BIC而不是使用MSE；

共性：
1. 考虑的因素均包含了趋势（是否damped）、季节（加法 / 乘法）；

