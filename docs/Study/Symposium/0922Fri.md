# 系统建模与优化


!!! abstract "课程简介" 

    交通相关：出行行为、网络均衡。

    最后几节课是研一同学的交流和讨论。并不适合不同专业方向的同学修这门课。

    > xw老师、xhl老师、wzl老师

    出勤：15%；
    讨论参与度：15%；
    选一个报告进行纪要以及自己的思考：30%；
    选一个论文进行细致阅读做一个PPT进行汇报：40%；

    -------------

    Sheffi MIT Urban Transportation-networks

!!! note "分类"
    - 道路交通流（微观，驾驶员行为，车辆速度、密度和流量）；
    - **网络交通流**（宏观，出行时间、出行方式和路径）🌟


!!! note "交通网络均衡分析的输入｜输出"
    输入：

    - 交通网络拓扑结构；
    - 路段出行时间（成本）函数 —— 阻抗函数（和流量差不多正相关）；
    - 交通需求分布矩阵（OD demand matrix, OD demand  function 有时候需求不是固定的，因为和==出行成本是相关的==递减函数）；
    - **出行者**路径选择决策规则（Path choice rules）

    ------------

    输出：
    
    - 路段的流量分布和出行时间

!!! note "描述"
    - Link：路段（一个有向边）
    - Node：节点N
    - Path：路径，从一个节点通向另一个节点的有向边集合；


    ---------

    1. 一个路口的不同描述：用四个节点表示一个十字路口而不是一个节点。（根据需求决定）


    ### 路段-路径关联矩阵

    > 这个路径是否包含一个link，包含就是1否则0。可以看出==哪个路径都经过了一个路段==；

    $$\begin{bmatrix} 1 & 2 & \cdots & k & \cdots & K \\ 2 & & & &  \\ 3 & & & &  \\ \cdots  & & \delta^{rs}_{a,k} &  &  \\ A & & & &  \end{bmatrix}$$

    矩阵的列数是 $r$ 到 $s$ 的路径数量；矩阵的行是图中所有的路段数；

    $\delta^{rs}_{a,k}$ : 如果连接 $r$ 到 $s$ 的路径 $k$ ，其包含第 $a$ 个路段，则为1，否则为0


    ### 路段、路径流量和时间

    路段流量：$x_a = \sum \sum f^{rs}_k \delta^{rs}_{a,k}$,   矩阵表示为 $x = \delta f$ ，意思是经过这个路段的每个路径的流量和；

    时间关系： $c^{rs}_k = \sum t_a(x_a)\delta^{rs}_{a,k}, \forall k, r,s$ ，路径 $k$ 上所有路段的时间和；


    ### 路段阻抗函数

    - $t_a(x_a)$： 路段阻抗函数：只跟路段a的流量有关（separable）
    - $t_a(\mathbb{x})$ : 和路段周边的路段的流量也有关（non-separable）

    - 零流时间：路段为空闲状态，车自由行驶完该段所需的时间；
    - 流量逼近通行极限，阻抗急剧上升，出行时间趋向正无穷。


    > Davidson's formula
    > 
    > $t_a(x_a) = t^0_a [1 + \alpha \dfrac{x_a}{C_a - x_a}]$
    > 
    > $C_a$ 是最大的路段流量，$x_a < C_a$

    > BPR function 
    > 
    > $t_a(x_a) = t^0_a [1 + \alpha (\dfrac{x_a}{C_a})^{\beta}]$ , $\alpha = 0.15, \beta = 4$，  $C_a$ 可以 $< x_a$，一旦超过设计流量，阻抗函数会急剧增加；


    ### 交通需求矩阵、函数

    $$\begin{bmatrix} & 1 & 2 & \cdots & s \\ 1 & q_{11} & & & \\ 2 & & & & \\ \cdots & & & & \\ r & & & & q_{rs}   \end{bmatrix}$$


    $q_{rs} = D_{rs}(c_{rs}), \forall r,s$ (OD demand function),表示从 $r$ 到 $s$ 的运输需求。 这里 $c_{rs}$ 是成本；

    $c_{rs} = D^{-1}_{rs}(q_{rs})$，反函数；


    ### 路径选择决策规则 

    - 效用最大化：最小时间、最小总成本、最小停站、....

## 用户均衡（UE）
    
- Each user wishes to minimize his or her travel time.
- 同一OD-pair之间所有被使用路径的出行时间相等，并比未使用的路径短；
- 所有出行者不可能**单方面**改变自己的路径选择来降低出行成本，因此不存在改变路径选择决策的动机。

> 囚徒困境。

```mermaid
flowchart LR
   1 --link1 --> 2
   1 --link2 --> 2

```

$t_1 = 2 + x_1, t_2 = 1 + 2x_2, x_1 + x_2 = 5$，问 $x_1$ 和 $x_2$ 最终的流量分别是多少？

> 看：如果Link 1 绝对占优，那么所有流量都走 Link 1 的费用必然比 此时的 Link 2 还要小。比较发现，此时一定是 $x_1, x_2$ 都有且二者费用相同时候才是均衡。

---------




数学描述

$\text{if} \hspace{5pt} f^{rs}_k = 0, c^{rs}_k > c^{rs}_{\text{min}};$

$\text{if} \hspace{5pt}  f^{rs}_k > 0, c^{rs}_k = c^{rs}_{\text{min}};$ 可以转化成非线性互补问题(`Nonlinear Complementarity Problem`)：

$$\begin{align}\begin{equation*}
\begin{cases}
f^{rs}_k (c^{rs}_k - c^{rs}_{\text{min}})  & =   0 \\
f^{rs}_k  & \geq   0 \\ 
c^{rs}_k - c^{rs}_{\text{min}} &  \geq   0 \\
\sum_kf^{rs}_k &  =  q_{rs}, \hspace{5pt} \forall r, s 
\end{cases}
\end{equation*}\end{align}$$


### 等价的数学规划模型（UE-MP）

> BMW formulation ; 最优解满足的条件就是我们上面的线性互补条件(KKT condition)，这里的目标函数的形式实际上是人为构造出来满足条件的表达式；

$$\min z(x) = \sum \int^{x_a}_0 t_a(\omega)d\omega \\
s.t. 
\begin{align}\begin{equation*}
\begin{cases}
\sum_kf^{rs}_k & = q_{rs} \hspace{5pt} \forall r, s  \\ 
f^{rs}_k & \geq 0 , \hspace{5pt} \forall k\\
x_a & = \sum_{rs} \sum_{k} f^{rs}_k \delta^{rs}_{a,k}, \forall a
\end{cases}
\end{equation*}\end{align}$$

!!! note "解释"
    这个问题的决策变量是$f^{rs}_k$，也就是路段的流量。第一个约束对应总量约束（需求 = 流量）；第二个约束对应流量非负约束；第三个约束对应每个路段的流量约束；



写出上述问题的KKT条件：

1. $\sum_{a} t_a(x_a) \dfrac{\partial x_a}{\partial f^{rs}_k} - \lambda_{rs} - \mu_{k}^{rs} = 0$
2. $\sum_kf^{rs}_k = q_{rs}, \hspace{5pt} \forall r, s$
3. $f^{rs}_k \geq 0 \hspace{5pt} \forall k, r,s$
4. $\mu^{rs}_k \geq 0\hspace{5pt} \forall k, r,s$
5. $f^{rs}_k \mu^{rs}_k = 0, \hspace{5pt} \forall k, r,s$

> 细节：（2）的第2个约束并不是 $\leq$ ，而是 $\geq$，在处理的时候要先变号，然后再使用 `KKT condition`。由于等式约束没有符号限制，所以对应的拉格朗日乘子可以变号不影响计算，这里为了方便也取负。
> 
> 见：本文结尾部分，KKT条件的推导。思路提纲：等式约束 + 不等式约束 -> 拉格朗日函数 -> 拉格朗日函数的一阶导数与乘子满足的性质。五个条件。

由（2）的第三个约束可见，$\dfrac{\partial x_a}{\partial f^{rs}_k} = \delta^{rs}_{a,k}, \forall r,s,k$，也就意味着 $\sum_{a} t_a(x_a) \dfrac{\partial x_a}{\partial f^{rs}_k} = \sum t_a(x_a) \delta^{rs}_{a,k} = c^{rs}_k$，我们可以把$r$到$s$第$k$条路的时间这个变量这个用上了。

所以可以把上述KKT条件整理成: $c^{rs}_k - \lambda_{rs} = \mu^{rs}_k; \mu^{rs}_k f^{rs}_k = 0$，所以可知：

1. if $\mu^{rs}_k = 0, c^{rs}_k = \lambda^{rs}$，此时$f^{rs}_k \geq 0$
2. if $\mu^{rs}_k \geq 0, c^{rs}_k \geq \lambda^{rs}$，此时$f^{rs}_k = 0$

> 其实是一个互补松弛的表示；

说明无论何种情况，$\lambda^{rs} = c^{rs}_{\text{min}}$.

> The optimal solution of the optimization problem (MP) = UE condition



### 解的存在性和唯一性

UE-MP模型是一个严格凸规划当且仅当路段出行时间函数是严格单调增函数，此时解存在且唯一。(对于路段来说是唯一的，但是对于路径而言不一定是唯一的)


```mermaid
flowchart LR
   1 --link1 --> 3
   2 --link2 --> 3
   3 --link3 --> 4
   3 --link4 --> 4
   4 --link5 --> 5 
```

此时我们已知阻抗函数 $t_1 = 1, t_2 = 2, t_3 = 2x_3, t_4 = 2 + 2x_4, t_5 = 1$，也知道$q_{15} = 2, q_{25} = 3$, 求UE状态。我们暂定 1 -> 3 -> 5 是 $f^{15}_1$， 同样 1 -> 4 -> 5 是 $f^{15}_2$，以此类推：2 -> 3 -> 5 是 $f^{25}_1$， 同样 2 -> 4 -> 5 是 $f^{25}_2$

很明显不存在一种情况是大家都只走 link3 or link4。 我们可以列出计算公式：

$2 + 2(f^{15}_{1} + f^{25}_1 ) = 2 (f^{15}_2 + f^{25}_2)$ 并代入需求总量2和3. 计算得出: $f^{15}_1 + f^{25}_1 = 3$。此时这两条路只要保证走3的流量和是3即可。比如：



| $f^{15}_1$ | $f^{15}_2$ | $f^{25}_1$ | $f^{25}_2$ |
| :--------: | :--------: | :--------: | :--------: |
|     2      |     0      |     1      |     2      |
|     0      |     2      |     3      |     0      |

这两种情况下平衡路径流量分配是不同的，但是这两种情况对应的路段流量分配是相同的。都是如下表所示：

| Link1 | Link2 | Link3 | Link4 | Link5 |
| :---: | :---: | :---: | :---: | :---: |
|   2   |   3   |   3   |   2   |   5   |


**所以问题虽然只有一个平衡路段流量分布结果，却有无限个平衡路径流量分布结果。**





!!! note "KKT条件Cheatsheet"

    考虑如下的优化问题：

    $$\min f(x) \\
    s.t. \begin{aligned}\begin{equation*}
    \begin{cases}
    h_i(x) = 0, \hspace{5pt} \forall i = 1, 2, ... m \\ 
    g_j(x) \leq 0, \hspace{5pt} \forall j = 1, 2, ... n \\     
    \end{cases}
    \end{equation*}\end{aligned}$$

    分别添加拉格朗日乘子并转化成无约束优化问题，推导后得出该约束条件最优解必然满足的五个条件，称为“KKT条件”（KKT condition）

    1. $\nabla f(x^*) + \sum_{i = 1}^m \lambda_i \nabla h_i(x^*) + \sum \mu_j \nabla g_j(x^*) = 0$; 一阶偏导数等于 $0$
    2. $h_i(x^*) = 0, \hspace{5pt} \forall i = 1, 2, ... m$，原等式约束；
    3. $g_j(x^*) \leq 0, \hspace{5pt} \forall j = 1, 2, ... n$，原不等式约束；
    4. $\mu_j \geq 0, \hspace{5pt} \forall j = 1, 2, ... n$，这是原不等式约束的拉格朗日乘子非负约束，注意等式约束不需要对拉格朗日乘子再约束了；
    5. $\mu_j  g_j(x^*) = 0, \hspace{5pt} \forall j = 1, 2, ... n$， 这是不等式约束的互补松弛条件（Complementary Slackness Condition）

